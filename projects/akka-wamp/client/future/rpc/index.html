<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="author" content="Paolo Angioletti">  
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    <title>Remote Procedure Calls - akka-wamp-0.11.0</title>

    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../..">akka-wamp-0.11.0</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../../router/">Router</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Client APIs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../overview/">Overview</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Actor based API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../actor/overview/">Overview</a>
</li>

        
            
<li >
    <a href="../../actor/session/">Session Handling</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Future based API</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../overview/">Overview</a>
</li>

        
            
<li >
    <a href="../session/">Session Handling</a>
</li>

        
            
<li >
    <a href="../pubsub/">Publish and Subscribe</a>
</li>

        
            
<li class="active">
    <a href="./">Remote Procedure Calls</a>
</li>

        
            
<li >
    <a href="../payload/">Payload Handling</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../stream/">Stream based API</a>
</li>

                        
                            
<li >
    <a href="../../config/">Configuration</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../../messages/">Messages</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../pubsub/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../payload/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#remote-procedure-calls">Remote Procedure Calls</a></li>
        
            <li class="second-level"><a href="#register-procedures">Register procedures</a></li>
            
                <li class="third-level"><a href="#invocation-handlers">Invocation handlers</a></li>
            
                <li class="third-level"><a href="#recover">Recover</a></li>
            
        
            <li class="second-level"><a href="#unregister-procedures">Unregister procedures</a></li>
            
                <li class="third-level"><a href="#recover_1">Recover</a></li>
            
        
            <li class="second-level"><a href="#call-procedures">Call procedures</a></li>
            
                <li class="third-level"><a href="#recover_2">Recover</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="remote-procedure-calls">Remote Procedure Calls</h1>
<pre><code class="scala">object RpcApp extends App {

  import akka.wamp.client._
  import akka.wamp.serialization._
  val client = Client()

  implicit val ec = client.executionContext

  val data = 
    for {
      session &lt;- client
        .openSession(
          url = &quot;ws://localhost:8080/router&quot;,
          subprotocol = &quot;wamp.2.json&quot;,
          realm = &quot;default.realm&quot;,
          roles = Set(&quot;callee&quot;))
      registration &lt;- session
        .register(
          procedure = &quot;myapp.procedure&quot;)(
          _.args.map { args =&gt;
            Payload(args)
          })
      result &lt;- session
        .call(
          procedure = &quot;myapp.procedure&quot;,
          args = List(&quot;paolo&quot;, 40, true))
      data &lt;- result.data
    } 
    yield (data)

  data.map(println)
}
</code></pre>

<p>The WAMP protocol defines a routed Remote Procedure Call (RPC) mechanism which relies on the same sort of decoupling that is used by the <a href="../../future/pubsub">Publish Subscribe</a> communication pattern. </p>
<p>A client, the callee, announces to the dealer router that it provides a certain procedure, identified by a procedure name.  Other clients, callers, can then call the procedure, with the dealer router invoking the procedure on the callee, receiving the procedure's result, and then forwarding this result back to the callers. Routed RPC differ from traditional client-server RPC in that the dealer router serves as an intermediary between the callers and the callee.</p>
<pre><code>   ,------.          ,------.               ,------.
   |Caller|          |Dealer|               |Callee|
   `--+---'          `--+---'               `--+---'   
      |                 |             REGISTER |
      |                 &lt;&lt;---------------------|
      |                 |                      |
      |                 | REGISTERED           |
      |                 |---------------------&gt;&gt;
      |                 |                      |
      | CALL            |                      |
      |----------------&gt;&gt;                      |
      |                 |                      |
      |                 | INVOCATION           | 
      |                 |---------------------&gt;&gt;
      |                 |                      |
      |                 |                YIELD |
      |                 &lt;&lt;---------------------|
      |                 |                      |
      |          RESULT |                      |
      &lt;&lt;----------------|                      |
   ,--+---.          ,--+---.               ,--+---.
   |Caller|          |Dealer|               |Callee|
   `------'          `------'               `------'
</code></pre>

<p>Akka Wamp provides you with an <a href="http://docs.scala-lang.org/overviews/core/futures.html">Future</a> based API to easily write both kind of clients: callee (those registering procedures) and callers (those calling them).</p>
<h2 id="register-procedures">Register procedures</h2>
<p>Once you got a callee session as documented in the <a href="../../future/session">Session Handling</a> section, you can finally register a procedure and its invocation handler:</p>
<pre><code class="scala">// val session = ... 

val registration: Future[Registration] = session.flatMap(
  _.register(
    procedure = &quot;myapp.procedure.echo&quot;) {
    invocation =&gt;
      invocation.args.map( args =&gt;
        Payload(args)
      )})
</code></pre>

<p>A (future of) session can be mapped to a (future of) registration by just invoking the <code>register</code> method. It is a curried method with two parameter lists.</p>
<pre><code class="scala">// as defined by Akka Wamp
def register(procedure: Uri)(handler: InvocationHandler)
</code></pre>

<p>The first parameter list accepts <code>procedure</code> as documented for the <a href="../../../messages#Register"><code>Register</code></a> message constructor. The second parameter list accepts a callback function of type <code>InvocationHandler</code>.</p>
<h3 id="invocation-handlers">Invocation handlers</h3>
<pre><code class="scala">// as defined by Akka Wamp
type InvocationHandler = (Invocation) =&gt; Future[Payload]
</code></pre>

<p>The invocation handler is a function that transforms an invocation to a (future of) output payload. The invocation comes with an input payload whose content can be lazily parsed as input arguments.</p>
<pre><code class="scala">// handler for &quot;myapp.procedure.sum&quot;
val handler: InvocationHandler = { invocation =&gt;
  invocation.kwargs.map { kwargs =&gt;
    val arg0 = kwargs(&quot;0&quot;).asInstanceOf[Int]
    val arg1 = kwargs(&quot;1&quot;).asInstanceOf[Int]
    Payload(List(arg0 + arg1))
  }}
</code></pre>

<p>Arguments can be received from the incoming payload and replied back as documented in the <a href="../payload">Payload Handling</a> section.</p>
<h3 id="recover">Recover</h3>
<p>You can either recover or <em>"give up"</em> when the (future of) registration fails. To recover from failures (such as <code>SessionException</code> thrown when the procedure has been already registered by some other callee or when the session turns out to be closed) you can compose <code>recoverWith</code> to attempt registering the procedure with a different name or to attempt another session (maybe to a fallback realm):</p>
<pre><code class="scala">val registration = session.flatMap(
  _.register(&quot;myapp.procedure.sum&quot;)(handler)
  .recoverWith { 
    case ex: SessionException =&gt; session.flatMap(
      _.register(&quot;myapp.procedure.sum.renamed&quot;)(handler)
  }
</code></pre>

<p>As last resort, instead of recovering, you could decide to <em>"give up"</em> a callback function <code>onFailure</code> that just prints a log message:</p>
<pre><code class="scala">session.onFailure {
  case ex: Throwable =&gt; 
    log.error(ex.getMessage, ex)
}
</code></pre>

<h2 id="unregister-procedures">Unregister procedures</h2>
<pre><code class="scala">import akka.wamp.messages._

val registration: Future[Registration] = ...

val unregistered: Future[Unregistered] = registration.flatMap(
  _.unregister()
)
</code></pre>

<p>Just call the <code>unregister()</code> method on the registration you want to terminate.</p>
<h3 id="recover_1">Recover</h3>
<p>TBD</p>
<h2 id="call-procedures">Call procedures</h2>
<p>Once you got a caller session as documented in the <a href="../../future/session">Session Handling</a> section, you can finally call a procedure:</p>
<pre><code class="scala">// val session = ... 

val result: Future[Result] = session.flatMap(
  _.call(
    procedure = &quot;myapp.procedure.sum&quot;,
    args = List(2, 4, 8, 12))
)

val data: Future[List[Any]] = result.flatMap(
  _.data
)
</code></pre>

<p>Arguments can be received from the resulting payload as documented in the <a href="../payload">Payload Handling</a> section.</p>
<h3 id="recover_2">Recover</h3>
<p>TBD</p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="../../../js/jquery-1.10.2.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../../..';
    </script>
    <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
    <script src="../../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
